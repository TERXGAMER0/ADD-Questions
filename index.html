<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>موقع تسجيل الأسئلة</title>
  <style>
    /* Reset & Base Styles */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { width:100%; height:100%; margin:0; padding:0; }
    body {
      background-color: #121212;
      color: #ffffff;
      font-family: Arial, sans-serif;
      font-size: 16px;
      direction: rtl;
    }
    h1 { font-size: 2rem; margin: 20px 0; }
    h3 { font-size: 1.5rem; margin: 15px 0; }
    p, label { font-size: 1rem; margin: 10px 0; }

    /* Page Layout */
    .page { display: none; padding:20px; width:100%; min-height:calc(100vh - 40px); }
    .active { display:block; }

    /* Form Controls */
    input, textarea, select {
      width:100%; padding:12px; margin:10px 0;
      font-size:1rem; background-color:#1f1f1f; color:#ffffff;
      border:1px solid #333333; border-radius:4px;
    }

    /* Buttons */
    button {
      display:block; width:100%; padding:12px; margin:10px 0;
      font-size:1rem; background-color:#1f1f1f; color:#ffffff;
      border:none; border-radius:4px; cursor:pointer;
    }
    button:hover { background-color:#333333; }

    /* Flex Containers */
    .flex-container {
      display:flex; justify-content:space-between;
      align-items:center; flex-wrap:wrap; gap:10px;
    }
    .flex-container > button {
      display:inline-block; width:auto; flex:none;
      margin:5px; padding:10px 15px;
    }

    /* Responsive Halves */
    .half { width:45%; }
    @media (max-width:768px) { .half { width:100%; } }

    /* Difficulty Buttons */
    .difficulty-button {
      display:inline-block; padding:10px; margin:5px;
      border:1px solid #ffffff; border-radius:4px;
      font-size:1rem; cursor:pointer;
    }
    .difficulty-button.selected { background-color:blue; }

    /* Question Blocks */
    .question-block {
      border:1px solid #ffffff; padding:15px;
      margin:15px 0; border-radius:4px;
    }
    .separator {
      margin:15px 0; text-align:center;
      font-size:0.875rem; color:#777777;
    }

    /* Manual File Display */
    #manualFileNameDisplay {
      display:inline-block; margin-top:10px;
      padding:5px; border:1px solid #ffffff;
      border-radius:4px; color:#ffffff;
    }
  </style>
</head>
<body>

  <!-- صفحة 1:0 - واجهة عرض الملفات من الخادم والخيارات اليدوية -->
  <div id="page-1-0" class="page active">
    <h1>واجهة ملفات النص من الخادم</h1>
    <button onclick="loadFilesList()">عرض الملفات المحفوظة</button>
    <div id="filesList" style="margin-top:10px;"></div>
    <button onclick="manualLoadFile()">تنزيل الملف من الجهاز</button>
    <input type="file" id="manualFileInput" accept=".txt" style="display:none" onchange="handleManualFile(event)">
    <div id="manualFileNameDisplay"></div>
    <div style="margin-top:15px;">
      <button onclick="goToWorkPage()">صفحة واجهة العمل</button>
      <button onclick="goToPage('page-1-1')">إنشاء ملف جديد</button>
    </div>
    <div style="margin-top:15px;">
      <button onclick="downloadSelectedFiles()">تحميل الملف النصي</button>
    </div>
  </div>

  <!-- صفحة 1:1 - واجهة إنشاء ملف txt جديد -->
  <div id="page-1-1" class="page">
    <h1>واجهة إنشاء ملف txt جديد</h1>
    <label>اكتب اسمك:</label>
    <input type="text" id="userNameInput" placeholder="اسم المستخدم">
    <div>
      <button onclick="handleNextFromCreateFile()">التالي</button>
      <button onclick="goToPage('page-1-0')">رجوع</button>
    </div>
  </div>

  <!-- صفحة 1:11 - واجهة رفع الملف النصي الجديد إلى الخادم -->
  <div id="page-1-11" class="page">
    <h1>رفع ملف txt الخاص بك إلى الخادم</h1>
    <button onclick="uploadFileAndGoBack()">رفع الى الخادم</button>
    <button onclick="downloadNewFile()">تنزيل الملف الجديد</button>
    <button onclick="goToPage('page-1-0')">رجوع</button>
  </div>

  <!-- صفحة 2:0 - واجهة العمل الرئيسية -->
  <div id="page-2-0" class="page">
    <div class="flex-container">
      <div id="displayUserName">اسم المستخدم</div>
      <button onclick="goToPage('page-2-1')">الإعدادات</button>
    </div>
    <h1>واجهة العمل</h1>
    <button style="font-size:18px; padding:15px 30px;" onclick="goToPage('page-3-0')">دخول صفحة إعداد سؤال</button>
  </div>

  <!-- صفحة 3:0 - واجهة إعداد السؤال -->
  <div id="page-3-0" class="page">
    <h1>واجهة إعداد السؤال</h1>
    <div class="flex-container">
      <div class="half">
        <label>ضع رقم الصفحة</label>
        <input type="number" id="pageNumberInput" placeholder="رقم الصفحة">
      </div>
      <div class="half">
        <label>ضع رقم السؤال</label>
        <input type="number" id="questionNumberInput" placeholder="رقم السؤال">
      </div>
    </div>
    <div>
      <p>حدد صعوبة السؤال:</p>
      <div id="difficultyOptions">
        <span class="difficulty-button" onclick="selectDifficulty(this, 'سهل جدًا')">سهل جدًا</span>
        <span class="difficulty-button" onclick="selectDifficulty(this, 'سهل')">سهل</span>
        <span class="difficulty-button" onclick="selectDifficulty(this, 'متوسط جدًا')">متوسط جدًا</span>
        <span class="difficulty-button" onclick="selectDifficulty(this, 'متوسط')">متوسط</span>
        <span class="difficulty-button" onclick="selectDifficulty(this, 'صعب')">صعب</span>
        <span class="difficulty-button" onclick="selectDifficulty(this, 'صعب جدًا')">صعب جدًا</span>
        <span class="difficulty-button" onclick="selectDifficulty(this, 'شديد الصعوبة')">شديد الصعوبة</span>
        <span class="difficulty-button" onclick="selectDifficulty(this, 'مستحيل الحل فقط حفظ')">مستحيل الحل فقط حفظ</span>
      </div>
    </div>
    <div>
      <label>ضع ملاحظتك:</label>
      <textarea id="noteInput" rows="4" placeholder="ملاحظتك هنا..."></textarea>
    </div>
    <div style="margin:10px 0;">
      <button onclick="saveAndAddQuestion()">حفظ السؤال وإضافة سؤال آخر</button>
    </div>
    <div class="flex-container">
      <button onclick="goToPage('page-1-0')">رجوع</button>
      <button onclick="saveQuestionsAndGoToDownload()">زر حفظ معلومات السؤال / الأسئلة</button>
    </div>
    <div id="newQuestionsDisplay" style="margin-top:20px; border:1px dashed #ffffff; padding:10px;"></div>
  </div>

  <!-- صفحة 4:0 - واجهة رفع الملف النصي المعدل إلى الخادم -->
  <div id="page-4-0" class="page">
    <h1>رفع الملف النصي المعدل إلى الخادم</h1>
    <button onclick="uploadFileAndGoBack()">رفع الى الخادم</button>
    <button onclick="manualDownloadFile()">تحميل على جهاز</button>
  </div>

  <!-- صفحة 2:1 - صفحة الإعدادات -->
  <div id="page-2-1" class="page">
    <h1>صفحة الإعدادات</h1>
    <div class="flex-container">
      <button onclick="goToPage('page-2-0')">رجوع</button>
      <div>
        <button onclick="saveSettings()">حفظ التعديل</button>
        <button onclick="saveSettingsAndReturn()">حفظ التعديل والانتقال</button>
        <button onclick="undoChange()">تراجع</button>
        <button onclick="redoChange()">تقدم</button>
      </div>
    </div>
    <div id="questionsList" style="margin-top:20px;"></div>
  </div>

  <!-- صفحة 2:11 - حفظ التعديلات والانتقال -->
  <div id="page-2:11" class="page">
    <h1>حفظ التعديلات</h1>
    <button onclick="uploadFile()">رفع الملف النصي</button>
  </div>

  <script>
    /*********************************************/
    /* المتغيرات العامة والتعليقات               */
    /*********************************************/
    let fileContent = "";
    let currentFileName = "";
    let oldQuestions = [];
    let newQuestions = [];
    let selectedDifficulty = "";
    const SEPARATOR = "——————————————————————————————————————————————————————————————";
    let undoStack = [];
    let redoStack = [];
    let selectedFiles = [];

    /*********************************************/
    /* دوال التنقل بين الصفحات                  */
    /*********************************************/
    function goToPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      if (pageId === 'page-2-0') {
        let header = fileContent.split("\n")[0];
        document.getElementById('displayUserName').innerText = header || "اسم المستخدم";
      }
      if (pageId === 'page-2-1') renderSettings();
      if (pageId === 'page-3-0') updateNewQuestionsDisplay();
    }

    /**************************************************/
    /* نظام التعامل مع الملفات على الخادم (API)       */
    /**************************************************/
    function loadFilesList() {
      fetch('/api/files')
        .then(res => res.json())
        .then(files => {
          files.sort((a,b) => parseInt(b.match(/(\d+)/)?.[0]||0) - parseInt(a.match(/(\d+)/)?.[0]||0));
          let list = document.getElementById('filesList');
          list.innerHTML = '';
          selectedFiles = [];
          files.forEach(f => {
            let btn = document.createElement('button');
            btn.innerText = f;
            btn.style.marginBottom = '5px';
            btn.onclick = () => {
              if (selectedFiles.includes(f)) {
                selectedFiles = selectedFiles.filter(x=>x!==f);
                btn.style.backgroundColor='#1f1f1f';
              } else {
                selectedFiles.push(f);
                btn.style.backgroundColor='blue';
              }
            };
            list.appendChild(btn);
          });
        })
        .catch(err => console.error('Error loading files:', err));
    }

    function downloadSelectedFiles() {
      if (selectedFiles.length===0) { alert('لم يتم اختيار أي ملفات.'); return; }
      selectedFiles.forEach(f => {
        fetch('/api/file?name='+encodeURIComponent(f))
          .then(r=>r.text())
          .then(txt=>{
            let blob=new Blob([txt],{type:'text/plain'});
            let link=document.createElement('a');
            link.href=URL.createObjectURL(blob);
            link.download=f;
            link.click();
          })
          .catch(err=>console.error('Error downloading file:',err));
      });
    }

    function selectFile(filename) {
      fetch('/api/file?name='+encodeURIComponent(filename))
        .then(r=>r.text())
        .then(txt=>{
          fileContent=txt;
          currentFileName=filename;
          parseQuestionsFromFile();
          alert('تم تحميل الملف: '+filename);
        })
        .catch(err=>console.error('Error loading file:',err));
    }

    function goToWorkPage() {
      let manual=document.getElementById('manualFileNameDisplay').innerText.trim();
      if (manual!=='') { goToPage('page-2-0'); return; }
      if (selectedFiles.length!==1) { alert('يجب عليك اختيار ملف واحد فقط وليس عدة ملفات.'); return; }
      if (currentFileName!==selectedFiles[0]) selectFile(selectedFiles[0]);
      goToPage('page-2-0');
    }

    function uploadFileAndGoBack() {
      let match=currentFileName.match(/معلوماتي تحديث رقم (\d+)/);
      let newName=match ? `معلوماتي تحديث رقم ${parseInt(match[1])+1}.txt` : 'معلوماتي تحديث رقم 1.txt';
      currentFileName=newName;
      fetch('/api/upload',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({filename:currentFileName,content:fileContent})
      })
      .then(r=>r.json())
      .then(_=>{
        alert('تم رفع الملف إلى الخادم: '+currentFileName);
        loadFilesList();
        goToPage('page-1-0');
      })
      .catch(err=>console.error('Error uploading file:',err));
    }

    /**********************************************************/
    /* نظام رفع الملف اليدوي من جهاز المستخدم (Local)         */
    /**********************************************************/
    function manualLoadFile(){ document.getElementById('manualFileInput').click(); }
    function handleManualFile(e){
      let file=e.target.files[0];
      if(!file) return;
      let reader=new FileReader();
      reader.onload=function(ev){
        fileContent=ev.target.result;
        currentFileName=file.name;
        parseQuestionsFromFile();
        document.getElementById('manualFileNameDisplay').innerText=file.name;
        alert('تم تحميل الملف من جهازك: '+file.name);
      };
      reader.readAsText(file);
    }

    function handleNextFromCreateFile(){
      let name=document.getElementById('userNameInput').value.trim();
      if(!name){ alert('من فضلك ادخل اسمك'); return; }
      fileContent=name+"\n\n\n";
      currentFileName='معلوماتي تحديث رقم 1.txt';
      oldQuestions=[];
      goToPage('page-1-11');
    }

    function parseQuestionsFromFile(){
      oldQuestions=[];
      let lines=fileContent.split("\n");
      let header=lines[0];
      let body=fileContent.substring(fileContent.indexOf(header)+header.length).trim();
      if(!body) return;
      body.split(SEPARATOR).forEach(part=>{
        let block=part.trim();
        if(!block) return;
        let ql=block.split("\n");
        oldQuestions.push({
          questionNumber: (ql[1]||'').split(':')[1]?.trim()||'',
          pageNumber:     (ql[2]||'').split(':')[1]?.trim()||'',
          difficulty:     (ql[3]||'').split(':')[1]?.trim()||'',
          note:           (ql[5]||'').trim(),
          fromFile:true
        });
      });
    }

    function formatQuestion(q,i){
      return `سؤال رقم ${i}
رقم السؤال : ${q.questionNumber}
رقم الصفحة : ${q.pageNumber}
صعوبه السؤال : ${q.difficulty}
الملاحظة على السؤال هي :
${q.note}
${SEPARATOR}
`;
    }

    function rebuildFileContent(){
      let header=fileContent.split("\n")[0];
      let all=oldQuestions.concat(newQuestions);
      let newC=header+"\n\n\n";
      all.forEach((q,i)=> newC+=formatQuestion(q,i+1));
      fileContent=newC;
    }

    function selectDifficulty(el,d){
      document.querySelectorAll('#difficultyOptions .difficulty-button').forEach(b=>b.classList.remove('selected'));
      el.classList.add('selected');
      selectedDifficulty=d;
    }

    function saveAndAddQuestion(){
      let p=document.getElementById('pageNumberInput').value.trim();
      let qn=document.getElementById('questionNumberInput').value.trim();
      let nt=document.getElementById('noteInput').value.trim();
      if(!p||!qn||!selectedDifficulty){ alert('من فضلك اكمل البيانات المطلوبة بما في ذلك صعوبة السؤال'); return; }
      newQuestions.push({questionNumber:qn,pageNumber:p,difficulty:selectedDifficulty,note:nt,fromFile:false});
      rebuildFileContent();
      updateNewQuestionsDisplay();
      document.getElementById('pageNumberInput').value='';
      document.getElementById('questionNumberInput').value='';
      document.getElementById('noteInput').value='';
      selectedDifficulty='';
    }

    function updateNewQuestionsDisplay(){
      let d=document.getElementById('newQuestionsDisplay');
      d.innerHTML='';
      newQuestions.forEach((q,i)=>{
        let div=document.createElement('div');
        div.style.marginBottom='10px';
        div.innerText=formatQuestion(q,oldQuestions.length+i+1);
        d.appendChild(div);
      });
    }

    function saveQuestionsAndGoToDownload(){ rebuildFileContent(); goToPage('page-4-0'); }

    function renderSettings(){
      let c=document.getElementById('questionsList');
      c.innerHTML='';
      let all=oldQuestions.concat(newQuestions);
      all.forEach((q,i)=>{
        let blk=document.createElement('div');
        blk.className='question-block';
        let h3=document.createElement('h3');
        h3.innerText=`رقم السؤال ${i+1}`;
        blk.appendChild(h3);
        let cd=document.createElement('div');
        cd.id=`question-content-${i}`;
        cd.innerHTML=`<p>
رقم السؤال : ${q.questionNumber}<br>
رقم الصفحة : ${q.pageNumber}<br>
صعوبه السؤال : ${q.difficulty}<br>
الملاحظة على السؤال هي :<br>${q.note}
</p>`;
        blk.appendChild(cd);
        let sep=document.createElement('div');
        sep.className='separator';
        sep.innerText=SEPARATOR;
        blk.appendChild(sep);
        let eb=document.createElement('button');
        eb.innerText='تعديل';
        eb.onclick=()=>enterEditMode(i);
        blk.appendChild(eb);
        let db=document.createElement('button');
        db.innerText='حذف';
        db.onclick=()=>deleteQuestion(i);
        blk.appendChild(db);
        c.appendChild(blk);
      });
    }

    function enterEditMode(i){
      let all=oldQuestions.concat(newQuestions);
      let q=all[i];
      let cd=document.getElementById(`question-content-${i}`);
      cd.innerHTML='';
      let form=document.createElement('div');
      form.className='edit-form';
      ['رقم السؤال:','رقم الصفحة:','صعوبه السؤال:','الملاحظة:'].forEach(lbl=>{
        let l=document.createElement('label');
        l.innerText=lbl;
        form.appendChild(l);
        let inp= lbl==='صعوبه السؤال:' ? document.createElement('select') : document.createElement(lbl==='الملاحظة:'?'textarea':'input');
        if(inp.tagName==='SELECT'){
          ["سهل جدًا","سهل","متوسط جدًا","متوسط","صعب","صعب جدًا","شديد الصعوبة","مستحيل الحل فقط حفظ"]
            .forEach(opt=>{
              let o=document.createElement('option');
              o.value=o.text=opt;
              if(q.difficulty===opt) o.selected=true;
              inp.appendChild(o);
            });
        } else {
          if(inp.tagName==='TEXTAREA') inp.rows=4;
          inp.value = lbl==='رقم السؤال:' ? q.questionNumber : lbl==='رقم الصفحة:' ? q.pageNumber : q.note;
        }
        form.appendChild(inp);
      });
      let save=document.createElement('button');
      save.innerText='حفظ';
      save.onclick=()=>saveEdit(i,form.querySelector('input').value,form.querySelectorAll('input')[1].value,form.querySelector('select').value,form.querySelector('textarea').value);
      form.appendChild(save);
      let cancel=document.createElement('button');
      cancel.innerText='إلغاء';
      cancel.onclick=renderSettings;
      form.appendChild(cancel);
      cd.appendChild(form);
    }

    function pushState(){
      undoStack.push({old:JSON.parse(JSON.stringify(oldQuestions)),new:JSON.parse(JSON.stringify(newQuestions))});
      redoStack=[];
    }

    function saveEdit(i,newQN,newPN,newD,newN){
      pushState();
      if(i<oldQuestions.length){
        Object.assign(oldQuestions[i],{questionNumber:newQN,pageNumber:newPN,difficulty:newD,note:newN});
      } else {
        Object.assign(newQuestions[i-oldQuestions.length],{questionNumber:newQN,pageNumber:newPN,difficulty:newD,note:newN});
      }
      rebuildFileContent();
      renderSettings();
    }

    function deleteQuestion(i){
      if(!confirm(`هل انت متأكد بحذف سؤال رقم ${i+1}؟`)) return;
      pushState();
      if(i<oldQuestions.length) oldQuestions.splice(i,1);
      else newQuestions.splice(i-oldQuestions.length,1);
      rebuildFileContent();
      renderSettings();
    }

    function undoChange(){
      if(!undoStack.length){ alert('لا يوجد شيء للتراجع عنه.'); return; }
      redoStack.push({old:JSON.parse(JSON.stringify(oldQuestions)),new:JSON.parse(JSON.stringify(newQuestions))});
      let prev=undoStack.pop();
      oldQuestions=prev.old; newQuestions=prev.new;
      rebuildFileContent(); renderSettings();
    }

    function redoChange(){
      if(!redoStack.length){ alert('لا يوجد شيء للتقدم إليه.'); return; }
      undoStack.push({old:JSON.parse(JSON.stringify(oldQuestions)),new:JSON.parse(JSON.stringify(newQuestions))});
      let nxt=redoStack.pop();
      oldQuestions=nxt.old; newQuestions=nxt.new;
      rebuildFileContent(); renderSettings();
    }

    function saveSettings(){ rebuildFileContent(); goToPage('page-4-0'); }
    function saveSettingsAndReturn(){ rebuildFileContent(); goToPage('page-2-0'); }

    function manualDownloadFile(){
      let blob=new Blob([fileContent],{type:'text/plain'});
      let link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download=currentFileName;
      link.click();
    }

    function downloadNewFile(){
      let blob=new Blob([fileContent],{type:'text/plain'});
      let link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download='معلوماتي تحديث رقم 1.txt';
      link.click();
    }
  </script>
</body>
</html>
